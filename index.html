<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebChat Pro</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root { --wa-green: #075E54; --wa-light-green: #25D366; --bg-gray: #e5ddd5; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background: #dadbd3; overflow: hidden; }
        
        /* Auth Screen */
        #auth-overlay { position: fixed; inset: 0; background: #f0f2f5; display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .auth-card { background: white; padding: 30px; border-radius: 10px; text-align: center; width: 320px; box-shadow: 0 17px 50px rgba(0,0,0,0.1); }
        .auth-card h2 { color: var(--wa-green); margin-bottom: 20px; }
        .auth-card input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .auth-btn { width: 100%; background: #00a884; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .toggle-link { color: #039be5; cursor: pointer; font-size: 13px; margin-top: 15px; display: block; }

        /* Main App Layout */
        #sidebar { width: 30%; min-width: 260px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        #chat-area { flex: 1; display: flex; flex-direction: column; background-color: var(--bg-gray); background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); position: relative; }
        
        .header { background: #ededed; padding: 10px 15px; font-weight: bold; border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; height: 60px; box-sizing: border-box; }
        
        #user-list { flex: 1; overflow-y: auto; }
        .user-item { padding: 15px; border-bottom: 1px solid #f2f2f2; cursor: pointer; display: flex; align-items: center; }
        .user-item:hover { background: #f5f5f5; }
        .user-item::before { content: ""; width: 35px; height: 35px; background: #00a884; border-radius: 50%; margin-right: 12px; }

        #messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 65%; padding: 8px 12px; font-size: 14.5px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); word-wrap: break-word; }
        .sent { align-self: flex-end; background: #dcf8c6; border-radius: 7.5px 0 7.5px 7.5px; }
        .received { align-self: flex-start; background: white; border-radius: 0 7.5px 7.5px 7.5px; }
        
        /* Video/Audio Calling */
        #video-grid { display: none; position: absolute; inset: 0; background: black; z-index: 1000; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { width: 100px; height: 130px; position: absolute; bottom: 80px; right: 20px; border: 2px solid white; border-radius: 8px; object-fit: cover; }
        #audio-ui { display: none; height: 100%; flex-direction: column; align-items: center; justify-content: center; color: white; background: var(--wa-green); }

        #input-area { background: #f0f0f0; padding: 10px 15px; display: flex; align-items: center; gap: 10px; }
        input#msg-input { flex: 1; border: none; padding: 12px 15px; border-radius: 20px; outline: none; }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div class="auth-card">
            <h2 id="auth-title">Login</h2>
            <input type="text" id="auth-user" placeholder="Username">
            <input type="password" id="auth-pass" placeholder="Password">
            <button class="auth-btn" id="auth-submit" onclick="handleAuth()">Login</button>
            <span class="toggle-link" onclick="toggleAuth()">Don't have an account? Sign Up</span>
        </div>
    </div>

    <div id="sidebar">
        <div class="header" id="my-name">Contacts</div>
        <div id="user-list"></div>
    </div>

    <div id="chat-area">
        <div class="header">
            <span id="chat-with">Select a user</span>
            <div id="call-btns" style="display:none;">
                <button onclick="startCall(true)" style="background:none; border:none; cursor:pointer; font-size:20px;">üéôÔ∏è</button>
                <button onclick="startCall(false)" style="background:none; border:none; cursor:pointer; font-size:20px; margin-left:10px;">üìû</button>
            </div>
        </div>
        <div id="messages"></div>
        <div id="video-grid">
            <div id="audio-ui"><h2>Voice Calling...</h2></div>
            <video id="remote-video" autoplay></video>
            <video id="local-video" autoplay muted></video>
            <button onclick="location.reload()" style="position:absolute; bottom:20px; left:40%; background:red; color:white; border:none; padding:10px 25px; border-radius:30px; cursor:pointer; font-weight:bold;">End Call</button>
        </div>
        <div id="input-area">
            <input type="text" id="msg-input" placeholder="Type a message">
            <button onclick="sendMessage()" id="send-btn" style="background:var(--wa-green); color:white; border:none; padding:10px 20px; border-radius:20px; cursor:pointer;">SEND</button>
        </div>
    </div>

    <script>
        const socket = io('https://mrfreakmessaging.onrender.com'); 
        const peer = new Peer();
        let myName = "";
        let selectedUser = { id: null, name: "" };
        let isSignup = false;
        let myStream;

        // Setup Media
        navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(s => {
            myStream = s;
            document.getElementById('local-video').srcObject = s;
        });

        function toggleAuth() {
            isSignup = !isSignup;
            document.getElementById('auth-title').innerText = isSignup ? "Sign Up" : "Login";
            document.getElementById('auth-submit').innerText = isSignup ? "Sign Up" : "Login";
            document.querySelector('.toggle-link').innerText = isSignup ? "Already have an account? Login" : "Don't have an account? Sign Up";
        }

        function handleAuth() {
            const u = document.getElementById('auth-user').value;
            const p = document.getElementById('auth-pass').value;
            if(!u || !p) return alert("Fill all fields");
            socket.emit(isSignup ? 'signup' : 'login', { username: u, password: p });
        }

        socket.on('auth-success', (data) => {
            myName = data.username;
            document.getElementById('my-name').innerText = "Logged in as: " + myName;
            document.getElementById('auth-overlay').style.display = 'none';
        });

        socket.on('error', (msg) => alert(msg));

        socket.on('update-users', (users) => {
            const list = document.getElementById('user-list');
            list.innerHTML = "";
            users.forEach(user => {
                if(user.nickname !== myName) {
                    const div = document.createElement('div');
                    div.className = 'user-item';
                    div.innerText = user.nickname;
                    div.onclick = () => {
                        selectedUser = { id: user.id, name: user.nickname };
                        document.getElementById('chat-with').innerText = user.nickname;
                        document.getElementById('call-btns').style.display = 'block';
                        document.getElementById('messages').innerHTML = "";
                        socket.emit('get-history', { me: myName, with: user.nickname });
                    };
                    list.appendChild(div);
                }
            });
        });

        socket.on('chat-history', (chats) => {
            chats.forEach(c => appendMessage(c.message, c.from === myName ? 'sent' : 'received'));
        });

        function sendMessage() {
            const text = document.getElementById('msg-input').value;
            if(!text || !selectedUser.id) return;
            socket.emit('private-msg', { toId: selectedUser.id, toName: selectedUser.name, message: text, from: myName });
            appendMessage(text, 'sent');
            document.getElementById('msg-input').value = "";
        }

        socket.on('new-msg', (data) => {
            if(data.fromName === selectedUser.name) appendMessage(data.message, 'received');
            else alert("New message from " + data.fromName);
        });

        function appendMessage(text, type) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerHTML = `<span>${text}</span> ${type==='sent' ? '<span style="color:#34b7f1; font-size:10px; margin-left:5px;">‚úì‚úì</span>':''}`;
            document.getElementById('messages').appendChild(div);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }

        // Call Logic
        function startCall(isAudio) {
            document.getElementById('video-grid').style.display = 'block';
            if(isAudio) document.getElementById('audio-ui').style.display = 'flex';
            socket.emit('request-video-id', { to: selectedUser.id, myPeerId: peer.id, isAudio: isAudio });
        }

        socket.on('receive-video-id', (data) => {
            if(confirm("Accept incoming call?")) {
                document.getElementById('video-grid').style.display = 'block';
                if(data.isAudio) document.getElementById('audio-ui').style.display = 'flex';
                const call = peer.call(data.peerId, myStream);
                call.on('stream', s => document.getElementById('remote-video').srcObject = s);
            }
        });

        peer.on('call', c => {
            document.getElementById('video-grid').style.display = 'block';
            c.answer(myStream);
            c.on('stream', s => document.getElementById('remote-video').srcObject = s);
        });

        document.getElementById('msg-input').onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };
    </script>
</body>
</html>
